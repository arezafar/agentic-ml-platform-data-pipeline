# =============================================================================
# Dockerfile.mage - Mage Orchestration with JDK for H2O Training
# =============================================================================
# DEV-01-02: JDK-enabled build for H2O cluster communication
#
# This Dockerfile is used for BOTH:
# - Scheduler: `mage start mlops_project`
# - Worker: `celery -A mage_ai.orchestration.executor worker`
#
# Key Features:
# - OpenJDK 17 for H2O training integration
# - Celery executor with Redis broker
# - Separate scheduler/worker isolation (PROC-01-03)
#
# Usage:
#   Scheduler: docker-compose up mage-scheduler
#   Workers:   docker-compose up mage-worker --scale mage-worker=4
# =============================================================================

FROM mageai/mageai:0.9.73

LABEL org.opencontainers.image.title="MLOps Mage Orchestrator"
LABEL org.opencontainers.image.description="Pipeline orchestration with H2O training support"
LABEL org.opencontainers.image.version="1.0.0"

WORKDIR /home/src

# Install OpenJDK 17 for H2O integration
USER root
RUN apt-get update && apt-get install -y --no-install-recommends \
    openjdk-17-jdk-headless \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Set JAVA_HOME for H2O
ENV JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
ENV PATH="${JAVA_HOME}/bin:${PATH}"

# Install Python dependencies for MLOps integration
# DEV-01-03: Version pinning for H2O compatibility
RUN pip install --no-cache-dir \
    h2o==3.46.0.1 \
    celery[redis]>=5.3.0 \
    psycopg2-binary>=2.9.0 \
    requests>=2.31.0 \
    numpy>=1.24.0 \
    pandas>=2.0.0 \
    httpx>=0.25.0 \
    asyncio>=3.4.3

# Copy pipeline code
COPY mage_pipeline /home/src/mlops_project

# Create data directories
RUN mkdir -p /data/exchange /models && \
    chown -R mage_user:mage_user /data /models

# Environment configuration
ENV PROJECT_NAME=mlops_project \
    MAGE_DATA_DIR=/home/src/mlops_project \
    H2O_URL=http://h2o-ai:54321 \
    CELERY_BROKER_URL=redis://redis:6379/0 \
    CELERY_RESULT_BACKEND=redis://redis:6379/0 \
    DATA_EXCHANGE_PATH=/data/exchange \
    MODEL_OUTPUT_PATH=/models

# Expose Mage UI port
EXPOSE 6789

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=5 \
    CMD curl -f http://localhost:6789/api/status || exit 1

# Switch to mage_user (non-root)
USER mage_user

# Default command (scheduler) - override for worker
CMD ["mage", "start", "mlops_project"]
