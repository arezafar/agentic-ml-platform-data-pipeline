# H2O StatefulSet - PHY-01-01
#
# This manifest deploys H2O as a StatefulSet with:
# - Headless service for stable network identities
# - Automatic cluster discovery via DNS
# - Memory configuration following 70/30 rule (JVM/Native)
#
# Key Patterns:
# - StatefulSet (not Deployment) for stable pod identities
# - Headless Service (ClusterIP: None) for peer discovery
# - H2O_KUBERNETES_SERVICE_DNS for automatic cloud formation

---
apiVersion: v1
kind: Service
metadata:
  name: h2o-service
  namespace: mlops
  labels:
    app: h2o
spec:
  # Headless service - exposes individual pod IPs
  clusterIP: None
  selector:
    app: h2o
  ports:
    - name: http
      port: 54321
      targetPort: 54321
    - name: internal
      port: 54322
      targetPort: 54322

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: h2o-cluster
  namespace: mlops
  labels:
    app: h2o
spec:
  serviceName: h2o-service
  replicas: 3 # H2O cluster size
  podManagementPolicy: Parallel # Start all pods simultaneously
  selector:
    matchLabels:
      app: h2o
  template:
    metadata:
      labels:
        app: h2o
    spec:
      terminationGracePeriodSeconds: 60

      containers:
        - name: h2o
          image: h2oai/h2o-open-source-k8s:3.44.0.3

          ports:
            - name: http
              containerPort: 54321
            - name: internal
              containerPort: 54322

          env:
            # Kubernetes service discovery
            - name: H2O_KUBERNETES_SERVICE_DNS
              value: "h2o-service.mlops.svc.cluster.local"

            # Cluster size must match replicas
            - name: H2O_NODE_LOOKUP_TIMEOUT
              value: "180"

            - name: H2O_NODE_EXPECTED_COUNT
              value: "3"

            # JVM Configuration
            # Memory Split: 70% JVM Heap, 30% Native (XGBoost/C++)
            # Container: 16Gi â†’ JVM: 11Gi, Native: ~5Gi
            - name: H2O_JVM_XMX
              value: "11g"

            - name: H2O_JVM_XMS
              value: "11g"

            # Additional JVM flags
            - name: JAVA_OPTS
              value: >-
                -XX:+UseG1GC
                -XX:MaxGCPauseMillis=100
                -XX:+UseStringDeduplication
                -XX:+ParallelRefProcEnabled

          resources:
            requests:
              memory: "16Gi"
              cpu: "4"
            limits:
              memory: "16Gi" # Hard limit for OOM prevention
              cpu: "8"

          # Liveness probe - basic HTTP check
          livenessProbe:
            httpGet:
              path: /3/About
              port: 54321
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3

          # Readiness probe - cluster health check
          # CRITICAL: Do not use simple HTTP check
          # Must verify cluster is fully formed
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - |
                  # Check if cluster is healthy and fully formed
                  response=$(wget -q -O - http://localhost:54321/3/Cloud 2>/dev/null)
                  if echo "$response" | grep -q '"cloud_healthy":true'; then
                    # Verify expected node count
                    node_count=$(echo "$response" | grep -o '"cloud_size":[0-9]*' | cut -d: -f2)
                    if [ "$node_count" -ge "$H2O_NODE_EXPECTED_COUNT" ]; then
                      exit 0
                    fi
                  fi
                  exit 1
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 6

          volumeMounts:
            - name: h2o-data
              mountPath: /data
            - name: h2o-models
              mountPath: /models

      # Anti-affinity: spread pods across nodes
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app: h2o
                topologyKey: kubernetes.io/hostname

  # Persistent volumes for data and models
  volumeClaimTemplates:
    - metadata:
        name: h2o-data
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: standard
        resources:
          requests:
            storage: 100Gi

    - metadata:
        name: h2o-models
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: standard
        resources:
          requests:
            storage: 20Gi

---
# PodDisruptionBudget for high availability
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: h2o-pdb
  namespace: mlops
spec:
  minAvailable: 2 # At least 2 nodes must be available
  selector:
    matchLabels:
      app: h2o
