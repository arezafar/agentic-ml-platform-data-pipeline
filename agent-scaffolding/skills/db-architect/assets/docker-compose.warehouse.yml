# =============================================================================
# Data Warehouse Foundation - Docker Compose
# =============================================================================
#
# Portable infrastructure for DB Architect workflow:
# - Mage: Orchestrator for ELT pipelines
# - PostgreSQL 14: Target data warehouse
# - H2O: Data profiling and statistical analysis engine
#
# Usage:
#   docker-compose -f docker-compose.warehouse.yml up -d
#   Open http://localhost:6789 for Mage UI
#
# =============================================================================

version: '3'

services:
  # ---------------------------------------------------------------------------
  # The Orchestrator - Mage
  # ---------------------------------------------------------------------------
  mage:
    image: mageai/mageai:latest
    container_name: warehouse-mage
    command: mage start data_warehouse_project
    environment:
      PROJECT_NAME: data_warehouse_project
      POSTGRES_CONNECT_TIMEOUT: 10
      POSTGRES_DB: magic
      POSTGRES_PASSWORD: password
      POSTGRES_USER: mage_user
      # H2O Connection
      H2O_URL: http://h2o:54321
    ports:
      - "6789:6789"
    volumes:
      - .:/home/src
      # Shared data exchange volume
      - data_exchange:/data/exchange
    depends_on:
      - postgres_warehouse
      - h2o
    restart: on-failure
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6789/api/status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ---------------------------------------------------------------------------
  # The Data Warehouse (Target)
  # ---------------------------------------------------------------------------
  postgres_warehouse:
    image: postgres:14
    container_name: warehouse-postgres
    restart: always
    environment:
      POSTGRES_USER: warehouse_admin
      POSTGRES_PASSWORD: warehouse_password
      POSTGRES_DB: warehouse_db
    ports:
      - "5432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
      # Init scripts (optional)
      - ./init-sql:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U warehouse_admin"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---------------------------------------------------------------------------
  # The Architect's Assistant (Profiling Engine)
  # ---------------------------------------------------------------------------
  h2o:
    image: h2oai/h2o-open-source-k8s:latest
    container_name: warehouse-h2o
    ports:
      - "54321:54321"
      - "54322:54322"
    command: java -jar /opt/h2oai/h2o-3/h2o.jar -name h2o_architect
    volumes:
      # Shared data exchange volume for zero-copy transfer
      - data_exchange:/data/exchange
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:54321/3/About"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 45s
    deploy:
      resources:
        limits:
          memory: 4G

volumes:
  # PostgreSQL persistent storage
  pg_data:
    driver: local
  
  # Shared volume for zero-copy data exchange between Mage and H2O
  data_exchange:
    driver: local
