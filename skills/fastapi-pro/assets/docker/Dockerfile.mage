# =============================================================================
# Dockerfile.mage - Mage Orchestration with Celery Executor
# =============================================================================
# Configured for production with separate scheduler and worker containers.
# Worker isolation prevents resource starvation and crash propagation.
#
# Usage:
#   Scheduler: docker-compose up mage-scheduler
#   Workers:   docker-compose up mage-worker --scale mage-worker=3
# =============================================================================

FROM mageai/mageai:latest

WORKDIR /home/src

# Install additional dependencies
RUN pip install --no-cache-dir \
    h2o>=3.46.0 \
    celery[redis]>=5.3.0 \
    psycopg2-binary>=2.9.0 \
    requests>=2.31.0 \
    numpy>=1.24.0 \
    pandas>=2.0.0

# Copy pipeline code
COPY mage_pipeline /home/src/mlops_project

# Environment variables
ENV PROJECT_NAME=mlops_project \
    H2O_URL=http://h2o-ai:54321 \
    MAGE_DATA_DIR=/home/src/mlops_project \
    CELERY_BROKER_URL=redis://redis:6379/0 \
    CELERY_RESULT_BACKEND=redis://redis:6379/0

# Create directories
RUN mkdir -p /data/exchange /models

# Expose Mage UI port
EXPOSE 6789

# Health check
HEALTHCHECK --interval=30s --timeout=10s --retries=5 \
    CMD curl -f http://localhost:6789/api/status || exit 1

# Default command (scheduler)
CMD ["mage", "start", "mlops_project"]
