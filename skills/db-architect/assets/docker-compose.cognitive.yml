# =============================================================================
# Docker Compose: Cognitive Data Architecture Stack
# =============================================================================
#
# Infrastructure for Agentic AI systems implementing:
# - Cognitive Memory Layer (PostgreSQL + pgvector)
# - Orchestration Layer (Mage)
# - ML Engine (H2O)
# - Network Isolation (frontend/agent tiers)
# - Zero-Copy Data Transfer (shared volumes)
#
# Usage:
#   docker-compose -f docker-compose.cognitive.yml up -d
#   docker-compose -f docker-compose.cognitive.yml logs -f postgres mage
#
# =============================================================================

version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # Cognitive Memory Layer - PostgreSQL + pgvector
  # The "Hippocampus" - All agent memory resides here
  # ---------------------------------------------------------------------------
  postgres:
    image: pgvector/pgvector:pg15
    container_name: cognitive-postgres
    hostname: postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-agentic}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-agentic_secret}
      POSTGRES_DB: ${POSTGRES_DB:-agentic_memory}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      # Persistent data storage
      - postgres-data:/var/lib/postgresql/data
      # Initialization scripts (run on first start)
      - ./init-db:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-agentic}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - agent_net  # ONLY internal network - no external access
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    command: >
      postgres
      -c shared_preload_libraries=vector
      -c max_connections=200
      -c shared_buffers=1GB
      -c effective_cache_size=3GB
      -c maintenance_work_mem=256MB
      -c work_mem=16MB

  # ---------------------------------------------------------------------------
  # Orchestration Layer - Mage
  # The "Spinal Cord" - Coordinates data movement and agent actions
  # ---------------------------------------------------------------------------
  mage:
    image: mageai/mageai:latest
    container_name: cognitive-mage
    hostname: mage
    ports:
      - "6789:6789"
    environment:
      USER_CODE_PATH: /home/src/cognitive_platform
      MAGE_DATABASE_CONNECTION_URL: postgresql://${POSTGRES_USER:-agentic}:${POSTGRES_PASSWORD:-agentic_secret}@postgres:5432/${POSTGRES_DB:-agentic_memory}
      # H2O Integration
      H2O_URL: http://h2o:54321
      # Environment injection for io_config
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-agentic}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-agentic_secret}
      POSTGRES_DB: ${POSTGRES_DB:-agentic_memory}
    volumes:
      # Pipeline code persistence
      - mage-code:/home/src
      # CRITICAL: Shared volume for zero-copy data transfer
      - data-exchange:/data/exchange
    depends_on:
      postgres:
        condition: service_healthy
      h2o:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6789/api/status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - frontend_net  # Exposed to users
      - agent_net     # Can talk to postgres and h2o
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

  # ---------------------------------------------------------------------------
  # ML Engine - H2O
  # The "Prefrontal Cortex" - Reasoning and prediction
  # ---------------------------------------------------------------------------
  h2o:
    image: h2oai/h2o-open-source-k8s:latest
    container_name: cognitive-h2o
    hostname: h2o
    ports:
      - "54321:54321"
      - "54322:54322"
    environment:
      H2O_XMX: 6g
      H2O_XMS: 4g
      H2O_CLUSTER_NAME: cognitive-h2o-cluster
    volumes:
      # CRITICAL: Shared volume for zero-copy data transfer
      - data-exchange:/data/exchange
      # Model persistence
      - h2o-models:/opt/h2o/models
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:54321/3/About"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 45s
    networks:
      - agent_net  # Internal only - no direct external access
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 6G

  # ---------------------------------------------------------------------------
  # Cache Layer - Redis (Optional)
  # Session state and rate limiting
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: cognitive-redis
    hostname: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - agent_net
    profiles:
      - with-cache
    deploy:
      resources:
        limits:
          memory: 1G

  # ---------------------------------------------------------------------------
  # Vector Embedding Service (Optional)
  # For local embedding generation without external API calls
  # ---------------------------------------------------------------------------
  embedding-service:
    image: huggingface/text-embeddings-inference:latest
    container_name: cognitive-embeddings
    hostname: embeddings
    ports:
      - "8080:80"
    environment:
      MODEL_ID: sentence-transformers/all-MiniLM-L6-v2
    networks:
      - agent_net
    profiles:
      - with-embeddings
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

# =============================================================================
# Networks: Tiered Security Architecture
# =============================================================================
networks:
  # Frontend: Exposed to load balancer/users
  frontend_net:
    driver: bridge
    name: cognitive-frontend
  
  # Agent: Internal only - contains sensitive memory
  agent_net:
    driver: bridge
    name: cognitive-agent
    internal: true  # CRITICAL: No external access to this network

# =============================================================================
# Volumes: Persistent Storage
# =============================================================================
volumes:
  # PostgreSQL data (cognitive memory)
  postgres-data:
    driver: local
  
  # Mage pipeline code
  mage-code:
    driver: local
  
  # CRITICAL: Zero-copy data exchange between services
  # Both Mage and H2O mount this for high-performance file transfer
  data-exchange:
    driver: local
  
  # H2O model storage (MOJO/POJO binaries)
  h2o-models:
    driver: local
  
  # Redis persistence
  redis-data:
    driver: local
