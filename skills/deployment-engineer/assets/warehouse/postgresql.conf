# =============================================================================
# PostgreSQL Production Tuning
# =============================================================================
# PHY-01-02: Production configuration for MLOps workloads
#
# Optimized for:
# - High-throughput bulk writes (feature ingestion)
# - JSONB query performance
# - Partitioned table maintenance
#
# Container Memory: 4GB (adjust based on container limits)
# =============================================================================

# -----------------------------------------------------------------------------
# Memory Configuration
# -----------------------------------------------------------------------------
# shared_buffers: 25% of container memory
shared_buffers = 1GB

# effective_cache_size: 75% of container memory (includes OS cache)
effective_cache_size = 3GB

# work_mem: Per-query memory for sorts/hashes
work_mem = 32MB

# maintenance_work_mem: For VACUUM, CREATE INDEX
maintenance_work_mem = 256MB

# -----------------------------------------------------------------------------
# WAL Configuration (Write-Ahead Log)
# -----------------------------------------------------------------------------
# Optimized for bulk writes from feature ingestion pipelines

# max_wal_size: Increase for bulk operations
max_wal_size = 4GB
min_wal_size = 1GB

# checkpoint_completion_target: Spread checkpoint I/O
checkpoint_completion_target = 0.9

# wal_buffers: WAL buffer size
wal_buffers = 64MB

# -----------------------------------------------------------------------------
# Query Planner
# -----------------------------------------------------------------------------
# random_page_cost: Lower for SSDs
random_page_cost = 1.1

# effective_io_concurrency: Concurrent I/O requests (SSDs)
effective_io_concurrency = 200

# default_statistics_target: Better query planning for JSONB
default_statistics_target = 200

# -----------------------------------------------------------------------------
# Connection Handling
# -----------------------------------------------------------------------------
max_connections = 200
superuser_reserved_connections = 3

# -----------------------------------------------------------------------------
# Partitioning & Extensions
# -----------------------------------------------------------------------------
# pg_partman background worker
shared_preload_libraries = 'pg_partman_bgw'

# pg_partman configuration
pg_partman_bgw.interval = 3600
pg_partman_bgw.role = 'postgres'
pg_partman_bgw.dbname = 'mlops'

# -----------------------------------------------------------------------------
# Logging
# -----------------------------------------------------------------------------
log_statement = 'ddl'
log_duration = off
log_min_duration_statement = 1000  # Log queries > 1 second

# -----------------------------------------------------------------------------
# Autovacuum (Important for JSONB tables)
# -----------------------------------------------------------------------------
autovacuum = on
autovacuum_max_workers = 4
autovacuum_naptime = 30s
autovacuum_vacuum_scale_factor = 0.05
autovacuum_analyze_scale_factor = 0.02
